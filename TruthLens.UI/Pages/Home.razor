@page "/"
@using System.Net.Http.Json
@using TruthLens.Shared.DTOs
@using System.Text.Json
@inject HttpClient Http
@using System.Linq

<div class="text-center my-5 animate__animated animate__fadeInDown">
    <h1 class="display-4 fw-bold text-primary"><i class="bi bi-search-heart"></i> TruthLens</h1>
    <p class="lead text-muted">
        AI-Powered Fake News Detection & Fact Verification System
    </p>
</div>

<div class="card shadow-sm mx-auto" style="max-width: 800px;">
    <div class="card-header bg-white p-0">
        <ul class="nav nav-tabs nav-fill" id="inputTabs">
            <li class="nav-item">
                <button class="nav-link @(activeTab == 0 ? "active fw-bold" : "")" @onclick="() => SetTab(0)">
                    <i class="bi bi-fonts"></i> Text Analysis
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == 1 ? "active fw-bold" : "")" @onclick="() => SetTab(1)">
                    <i class="bi bi-link-45deg"></i> URL Analysis
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == 2 ? "active fw-bold" : "")" @onclick="() => SetTab(2)">
                    <i class="bi bi-image"></i> Screenshot OCR
                </button>
            </li>
        </ul>
    </div>

    <div class="card-body p-4">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger d-flex align-items-center">
                <i class="bi bi-exclamation-octagon-fill me-2 fs-4"></i>
                <div>@errorMessage</div>
            </div>
        }

        @if (activeTab == 0)
        {
            <div class="mb-3 animate__animated animate__fadeIn">
                <label class="form-label text-secondary fw-bold">Paste the news text here:</label>
                <textarea class="form-control" rows="6" @bind="inputText" placeholder="e.g. According to breaking reports..."></textarea>
            </div>
        }

        @if (activeTab == 1)
        {
            <div class="mb-3 animate__animated animate__fadeIn">
                <label class="form-label text-secondary fw-bold">Paste the news link (URL):</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-globe"></i></span>
                    <input type="text" class="form-control" @bind="inputUrl" placeholder="https://example.com/news-article..." />
                </div>
                <small class="text-muted fst-italic mt-1 d-block">System will scrape the content from the provided link.</small>
            </div>
        }

        @if (activeTab == 2)
        {
            <div class="mb-3 text-center border rounded p-4 bg-light animate__animated animate__fadeIn">
                <i class="bi bi-cloud-arrow-up display-4 text-primary opacity-50"></i>
                <br />
                <label class="form-label mt-2 fw-bold text-secondary">Upload a screenshot</label>
                <InputFile OnChange="HandleFileSelected" class="form-control mt-2" accept="image/*" />

                @if (!string.IsNullOrEmpty(imageBase64Preview))
                {
                    <div class="mt-3 position-relative d-inline-block">
                        <img src="@imageBase64Preview" class="img-thumbnail shadow-sm" style="max-height: 200px;" />
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                            <i class="bi bi-check"></i> Ready
                        </span>
                    </div>
                }
            </div>
        }

        <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary btn-lg shadow-sm" @onclick="AnalyzeAsync" disabled="@isLoading">
                @if (isLoading)
                {
                    <span><span class="spinner-border spinner-border-sm me-2"></span> Analyzing Truth...</span>
                }
                else
                {
                    <span><i class="bi bi-magic me-2"></i> Analyze Content</span>
                }
            </button>
        </div>
    </div>
</div>

@if (result != null)
{
    <div class="mt-5 mx-auto animate__animated animate__fadeInUp" style="max-width: 800px; padding-bottom: 100px;">

        @{
            var isFake = result.AiLabel == "FAKE";
            var mainColor = isFake ? "danger" : "success";
        }

        @if (!string.IsNullOrEmpty(result.FactCheckResult))
        {
            <div class="card border-@mainColor shadow-sm mb-4 border-2 animate__animated animate__pulse">
                <div class="card-body d-flex align-items-center bg-@mainColor bg-opacity-10">
                    <div class="me-4">
                        <i class="bi bi-shield-exclamation text-@mainColor display-3"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold text-@mainColor">Official Fact-Check Result</h4>
                        <p class="lead mb-0 text-dark fw-bold">
                            @result.FactCheckResult
                        </p>
                        <small class="text-muted">Verified by Google Fact Check Tools</small>
                    </div>
                </div>
            </div>
        }

        <div class="card shadow-lg border-0 mb-4 animate__animated animate__fadeInUp">

            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="fw-bold m-0 text-dark">
                    <i class="bi bi-robot text-primary me-2"></i> AI Deep Analysis
                </h5>
                <span class="badge bg-@mainColor px-4 py-2 rounded-pill shadow-sm fs-6">
                    @result.AiLabel (%@result.AiScore.ToString("F1"))
                </span>
            </div>

            <div class="card-body p-4">

                <div>
                    <h6 class="text-muted fw-bold text-uppercase small mb-3">
                        <i class="bi bi-bar-chart-steps me-1"></i> Confidence Breakdown
                    </h6>

                    @if (result.CategoryScores != null && result.CategoryScores.Count > 0)
                    {
                        <div class="row">
                            @foreach (var category in result.CategoryScores.OrderByDescending(x => x.Value))
                            {
                                string barColor = "danger";
                                string icon = "bi-exclamation-circle-fill";

                                if (category.Key.Contains("Trusted") || category.Key.Contains("Real"))
                                {
                                    barColor = "success";
                                    icon = "bi-check-circle-fill";
                                }

                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fw-bold text-dark small">
                                            <i class="bi @icon text-@barColor me-1 opacity-75"></i> @category.Key
                                        </span>
                                        <span class="fw-bold text-@barColor small">%@category.Value.ToString("F1")</span>
                                    </div>
                                    <div class="progress" style="height: 18px; border-radius: 9px; background-color: #f1f3f5;">
                                        <div class="progress-bar bg-@barColor progress-bar-striped" role="progressbar"
                                             style="width: @category.Value.ToString("0", System.Globalization.CultureInfo.InvariantCulture)%"
                                             aria-valuenow="@category.Value" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-light text-center small text-muted">
                            Detailed score breakdown not available.
                        </div>
                    }
                </div>

                <hr class="my-4 text-muted opacity-25">

                <div>
                    <p class="card-text text-secondary mb-0" style="white-space: pre-line; font-size: 1.05rem; line-height: 1.7; text-align: justify;">
                        <i class="bi bi-chat-right-quote-fill text-muted me-2 opacity-50"></i>
                        @result.AiExplanation
                    </p>
                </div>

            </div>
        </div>

        @if (result.SimilarNews != null && result.SimilarNews.Count > 0)
        {
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light py-3 border-bottom">
                    <h5 class="fw-bold m-0 text-secondary">
                        <i class="bi bi-globe2 me-2"></i> Related Sources & Verification
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    @foreach (var news in result.SimilarNews)
                    {
                        <a href="@news.Url" target="_blank" class="list-group-item list-group-item-action p-4 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 text-primary fw-bold" style="font-size: 1.1rem;">
                                    @(string.IsNullOrEmpty(news.Title) ? news.Url : news.Title)
                                </h6>
                                <div class="mt-2">
                                    <span class="badge bg-light text-dark border me-2">
                                        <i class="bi bi-building"></i> @news.Source
                                    </span>
                                    <small class="text-muted">Click to read full article</small>
                                </div>
                            </div>
                            <i class="bi bi-box-arrow-up-right text-secondary fs-4"></i>
                        </a>
                    }
                </div>
            </div>
        }

        <div class="text-center mt-5">
            <button class="btn btn-link text-muted text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#contentCollapse">
                <i class="bi bi-eye"></i> Show Analyzed Content Snippet
            </button>
        </div>

        <div class="collapse mt-2" id="contentCollapse">
            <div class="card card-body bg-light border-0 small text-muted fst-italic mx-4">
                @if (!string.IsNullOrEmpty(result.AnalyzedContent))
                {
                    @(result.AnalyzedContent.Length > 600 ? result.AnalyzedContent.Substring(0, 600) + "..." : result.AnalyzedContent)
                }
            </div>
        </div>

    </div>
}

@code {
    private int activeTab = 0; // 0: Text, 1: Url, 2: Image

    private string inputText = "";
    private string inputUrl = "";
    private string imageBase64Data = "";
    private string imageBase64Preview = "";

    private bool isLoading = false;
    private string errorMessage = "";

    private AnalysisResponse? result;

    private void SetTab(int tabIndex)
    {
        activeTab = tabIndex;
        result = null;
        errorMessage = "";
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            // Resize for performance
            var resizedFile = await file.RequestImageFileAsync(file.ContentType, 800, 800);
            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream(maxAllowedSize: 5120000).ReadAsync(buffer); // Max 5MB

            var base64 = Convert.ToBase64String(buffer);

            imageBase64Preview = $"data:{file.ContentType};base64,{base64}";
            imageBase64Data = base64;
        }
        catch (Exception ex)
        {
            errorMessage = "Image upload failed: " + ex.Message;
        }
    }

    private async Task AnalyzeAsync()
    {
        isLoading = true;
        errorMessage = "";
        result = null;

        try
        {
            var request = new AnalysisRequest();

            if (activeTab == 0) // Text
            {
                if (string.IsNullOrWhiteSpace(inputText)) throw new Exception("Please enter some text to analyze.");
                request.InputType = "text";
                request.Content = inputText;
            }
            else if (activeTab == 1) // URL
            {
                if (string.IsNullOrWhiteSpace(inputUrl)) throw new Exception("Please enter a valid URL.");
                request.InputType = "url";
                request.Content = inputUrl;
            }
            else if (activeTab == 2) // Image
            {
                if (string.IsNullOrWhiteSpace(imageBase64Data)) throw new Exception("Please upload an image first.");
                request.InputType = "image";
                request.Content = imageBase64Data;
            }

            // JSON Case Sensitivity ayarı ile garantiye alalım
            var jsonOptions = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var response = await Http.PostAsJsonAsync("api/Analyze/analyze", request);

            if (response.IsSuccessStatusCode)
            {
                // DTO özellik isimleri (CamelCase/PascalCase) karışıklığını önlemek için options ekledim
                result = await response.Content.ReadFromJsonAsync<AnalysisResponse>(jsonOptions);

                if (!result.IsSuccess)
                {
                    errorMessage = "Server Message: " + result.Message;
                    result = null;
                }
            }
            else
            {
                errorMessage = $"Connection Error: {response.ReasonPhrase} ({response.StatusCode})";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}