@page "/"
@using System.Net.Http.Json
@using TruthLens.Shared.DTOs 
@inject HttpClient Http

<div class="text-center my-5 animate__animated animate__fadeInDown">
    <h1 class="display-4 fw-bold text-primary"><i class="bi bi-search-heart"></i> TruthLens</h1>
    <p class="lead text-muted">
        AI-Powered Fake News Detection & Fact Verification System
    </p>
</div>

<div class="card shadow-sm mx-auto" style="max-width: 800px;">
    <div class="card-header bg-white p-0">
        <ul class="nav nav-tabs nav-fill" id="inputTabs">
            <li class="nav-item">
                <button class="nav-link @(activeTab == 0 ? "active fw-bold" : "")" @onclick="() => SetTab(0)">
                    <i class="bi bi-fonts"></i> Text Analysis
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == 1 ? "active fw-bold" : "")" @onclick="() => SetTab(1)">
                    <i class="bi bi-link-45deg"></i> URL Analysis
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == 2 ? "active fw-bold" : "")" @onclick="() => SetTab(2)">
                    <i class="bi bi-image"></i> Screenshot OCR
                </button>
            </li>
        </ul>
    </div>

    <div class="card-body p-4">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger d-flex align-items-center">
                <i class="bi bi-exclamation-octagon-fill me-2 fs-4"></i>
                <div>@errorMessage</div>
            </div>
        }

        @if (activeTab == 0)
        {
            <div class="mb-3 animate__animated animate__fadeIn">
                <label class="form-label text-secondary fw-bold">Paste the news text here:</label>
                <textarea class="form-control" rows="6" @bind="inputText" placeholder="e.g. According to breaking reports from Mars..."></textarea>
            </div>
        }

        @if (activeTab == 1)
        {
            <div class="mb-3 animate__animated animate__fadeIn">
                <label class="form-label text-secondary fw-bold">Paste the news link (URL):</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-globe"></i></span>
                    <input type="text" class="form-control" @bind="inputUrl" placeholder="https://example.com/news-article..." />
                </div>
                <small class="text-muted fst-italic mt-1 d-block">System will scrape the content from the provided link.</small>
            </div>
        }

        @if (activeTab == 2)
        {
            <div class="mb-3 text-center border rounded p-4 bg-light animate__animated animate__fadeIn">
                <i class="bi bi-cloud-arrow-up display-4 text-primary opacity-50"></i>
                <br />
                <label class="form-label mt-2 fw-bold text-secondary">Upload a screenshot</label>
                <InputFile OnChange="HandleFileSelected" class="form-control mt-2" accept="image/*" />
                
                @if (!string.IsNullOrEmpty(imageBase64Preview))
                {
                    <div class="mt-3 position-relative d-inline-block">
                        <img src="@imageBase64Preview" class="img-thumbnail shadow-sm" style="max-height: 200px;" />
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                            <i class="bi bi-check"></i> Ready
                        </span>
                    </div>
                }
            </div>
        }

        <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary btn-lg shadow-sm" @onclick="AnalyzeAsync" disabled="@isLoading">
                @if (isLoading)
                {
                    <span><span class="spinner-border spinner-border-sm me-2"></span> Analyzing Truth...</span>
                }
                else
                {
                    <span><i class="bi bi-magic me-2"></i> Analyze Content</span>
                }
            </button>
        </div>
    </div>
</div>

@if (result != null)
{
    <div class="mt-5 mx-auto animate__animated animate__fadeInUp" style="max-width: 800px; padding-bottom: 50px;">
        
        @{
            // Karar Mantığı: Etiket FAKE ise veya Google "False" dediyse Kırmızı yap
            var isFake = result.AiLabel == "FAKE";
            
            var headerClass = isFake ? "bg-danger" : "bg-success";
            var iconClass = isFake ? "bi-exclamation-triangle-fill" : "bi-patch-check-fill";
            var titleText = isFake ? "SUSPICIOUS / UNVERIFIED" : "VERIFIED / TRUSTED";
            var scoreColor = isFake ? "text-danger" : "text-success";
        }

        <div class="card shadow-lg border-0 overflow-hidden">
            <div class="card-header @headerClass text-white text-center py-4">
                <h2 class="fw-bold mb-0 text-uppercase"><i class="bi @iconClass me-2"></i> @titleText</h2>
                <div class="mt-2">
                    <span class="badge bg-white @scoreColor fs-6 px-3 py-2 rounded-pill shadow-sm">
                        Confidence Score: <strong>%@result.AiScore.ToString("F1")</strong>
                    </span>
                </div>
            </div>

            <div class="card-body p-4 bg-light">
                
                @if(result.AiExplanation.Contains("PROVEN FALSE") || result.AiExplanation.Contains("Verdict: False"))
                {
                     <div class="alert alert-danger border-2 border-danger d-flex align-items-start mb-4 shadow-sm">
                        <i class="bi bi-shield-lock-fill fs-1 me-3 text-danger"></i>
                        <div>
                            <h5 class="alert-heading fw-bold">CRITICAL WARNING</h5>
                            <p class="mb-0">
                                Although the writing style might appear normal, <strong>Google Fact-Check</strong> sources have explicitly confirmed this information is <strong>FALSE</strong>. Do not trust this content.
                            </p>
                        </div>
                    </div>
                }

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-secondary border-bottom pb-2 mb-3">
                            <i class="bi bi-robot me-2"></i> Detailed Analysis
                        </h5>
                        <p class="card-text" style="white-space: pre-line; line-height: 1.6; color: #333;">
                            @result.AiExplanation
                        </p>
                    </div>
                </div>

                <div class="text-center">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#contentCollapse">
                        <i class="bi bi-eye"></i> Show Analyzed Text Snippet
                    </button>
                </div>
                
                <div class="collapse mt-3" id="contentCollapse">
                    <div class="card card-body bg-white border text-muted small fst-italic">
                        @if(!string.IsNullOrEmpty(result.AnalyzedContent))
                        {
                            @(result.AnalyzedContent.Length > 400 ? result.AnalyzedContent.Substring(0, 400) + "..." : result.AnalyzedContent)
                        }
                    </div>
                </div>

            </div>
            
            <div class="card-footer bg-white text-center text-muted py-3">
                 <small><i class="bi bi-shield-check"></i> Analysis performed by TruthLens AI & Google Verification Services</small>
            </div>
        </div>
    </div>
}

@code {
    private int activeTab = 0; // 0: Text, 1: Url, 2: Image

    private string inputText = "";
    private string inputUrl = "";
    private string imageBase64Data = ""; // API'ye gidecek saf veri
    private string imageBase64Preview = ""; // Ekranda görünecek veri

    private bool isLoading = false;
    private string errorMessage = "";

    private AnalysisResponse? result;


    private void SetTab(int tabIndex)
    {
        activeTab = tabIndex;
        result = null; 
        errorMessage = "";
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            // get image asa 800x800 max (for performance) tihs might change due to tesserct performance
            var resizedFile = await file.RequestImageFileAsync(file.ContentType, 800, 800);
            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream(maxAllowedSize: 5120000).ReadAsync(buffer); // Max 5MB

            var base64 = Convert.ToBase64String(buffer);

            imageBase64Preview = $"data:{file.ContentType};base64,{base64}";
            imageBase64Data = base64; 
        }
        catch (Exception ex)
        {
            errorMessage = "Image upload failed: " + ex.Message;
        }
    }

    // API query
    private async Task AnalyzeAsync()
    {
        isLoading = true;
        errorMessage = "";
        result = null;

        try
        {
            // Shared DTO 
            var request = new AnalysisRequest();

            if (activeTab == 0) // Text
            {
                if (string.IsNullOrWhiteSpace(inputText)) throw new Exception("Please enter some text to analyze.");
                request.InputType = "text";
                request.Content = inputText;
            }
            else if (activeTab == 1) // URL
            {
                if (string.IsNullOrWhiteSpace(inputUrl)) throw new Exception("Please enter a valid URL.");
                request.InputType = "url";                
                request.Content = inputUrl;
            }
            else if (activeTab == 2) // Image
            {
                if (string.IsNullOrWhiteSpace(imageBase64Data)) throw new Exception("Please upload an image first.");
                request.InputType = "image";
                request.Content = imageBase64Data;
            }

            var response = await Http.PostAsJsonAsync("api/Analyze/analyze", request);

            if (response.IsSuccessStatusCode)
            {
                result = await response.Content.ReadFromJsonAsync<AnalysisResponse>();
                
                if(!result.IsSuccess)
                {
                    errorMessage = "Server Message: " + result.Message;
                    result = null; 
                }
            }
            else
            {
                errorMessage = $"Connection Error: {response.ReasonPhrase} ({response.StatusCode})";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}